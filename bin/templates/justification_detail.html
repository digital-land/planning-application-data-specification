{% extends "base.html" %}
{% set spec_route = "decisions" %}
{% from "macros/data_chips.html" import data_chip %}

{% block app_breadcrumbs %}
  {{- govukBreadcrumbs(breadcrumbs | default({
    'items': [
      {
        'text': "Home",
        'href': base_url + "/"
      },
      {
        'text': "Justification",
        'href': base_url + "/justification"
      },
      {
        'text': id,
      }
    ]
  })) -}}
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <span class="govuk-caption-xl">{{ id }}</span>
    <h1 class="govuk-heading-xl">{{ title or ('Justification ' ~ id) }}</h1>

    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Needs</dt>
        <dd class="govuk-summary-list__value">
          {% if needs_links %}
            {{ needs_links | join(', ') | safe }}
          {% else %}
            {{ needs | join(', ') }}
          {% endif %}
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Satisfaction</dt>
        <dd class="govuk-summary-list__value">{{ satisfaction }}</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Confidence</dt>
        <dd class="govuk-summary-list__value">{{ confidence }}</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Status</dt>
        <dd class="govuk-summary-list__value">{{ status }}</dd>
      </div>
    </dl>

    {% if body %}
      <div class="govuk-body">
        {{ body | safe }}
      </div>
    {% endif %}

    <hr class="govuk-section-break govuk-section-break--visible govuk-section-break--l app-strong-section-break">

    {% if raw and raw.get("satisfied_by") %}
      <h2 class="govuk-heading-m">Satisfied by:</h2>
      <div class="govuk-body">
        {% set sb = raw.get("satisfied_by") %}

        {% macro render_condition(cond) %}
          {% if cond.get("allOf") %}
            <div class="govuk-!-margin-bottom-2">
              <p class="govuk-body">All of these are required:</p>
              <div class="govuk-!-margin-left-2">
                {% for sub in cond.get("allOf") %}
                  <div class="govuk-!-margin-bottom-1">{{ render_condition(sub) }}</div>
                  {% if not loop.last %}
                    <span class="govuk-body">and</span>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% elif cond.get("anyOf") %}
            <div class="govuk-!-margin-bottom-2">
              <p class="govuk-body">One of:</p>
              <div class="govuk-!-margin-left-2">
                {% for sub in cond.get("anyOf") %}
                  <div class="govuk-!-margin-bottom-1">{{ render_condition(sub) }}</div>
                  {% if not loop.last %}
                    <span class="govuk-body">or</span>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% elif cond.get("dataset") and cond.get("field") %}
            {{ data_chip("Field", cond.get("field")) }} in {{ data_chip("Dataset", cond.get("dataset")) }}
          {% elif cond.get("dataset") %}
            Having {{ data_chip("Dataset", cond.get("dataset")) }}
          {% elif cond.get("field") %}
            {{ data_chip("Field", cond.get("field")) }}
          {% elif cond.get("codelist") %}
            {{ data_chip("Codelist", cond.get("codelist")) }}
            {% if cond.get("includes") %}
              {{ data_chip("Includes code", cond.get("includes") | join(", ")) }}
            {% endif %}
          {% elif cond.get("rule") %}
            <pre>{{ cond | tojson(indent=2) }}</pre>
          {% endif %}
        {% endmacro %}

        {% if sb is mapping and sb.get("allOf") %}
          {{ render_condition({"allOf": sb.get("allOf")}) }}
        {% elif sb is mapping and sb.get("anyOf") %}
          {{ render_condition({"anyOf": sb.get("anyOf")}) }}
        {% elif sb is mapping and sb.get("rule") %}
          <p class="govuk-body">Rule:</p>
          <pre>{{ sb.get("rule") | tojson(indent=2) }}</pre>
        {% elif sb is sequence %}
          <div class="govuk-!-margin-bottom-3">
            {% for cond in sb %}
              <div class="govuk-!-margin-bottom-1">{{ render_condition(cond) }}</div>
              {% if not loop.last %}
                <span class="govuk-body">and</span>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    <hr class="govuk-section-break govuk-section-break--visible govuk-section-break--l app-strong-section-break">
    <h2 class="govuk-heading-m">Help improve this specification</h2>
    <p class="govuk-body">To help keep this justification useful and up to date, you can:</p>
    <ul class="govuk-list govuk-list--bullet">
      <li><a class="govuk-link" href="{{ github_issue_url }}">Raise feedback on GitHub for {{ id }}</a></li>
      <li><a class="govuk-link" href="{{ github_edit_url }}">Propose an edit on GitHub</a></li>
    </ul>
  </div>
</div>
{% endblock %}
